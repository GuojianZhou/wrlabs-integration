From 9b430ee73655e451d73f495022950730f538b8dd Mon Sep 17 00:00:00 2001
From: fupan li <fupan.li@windriver.com>
Date: Fri, 29 May 2015 11:26:42 +0800
Subject: [PATCH] smartpm: add a builddep command to install all of the build
 required packages

This command will figure of the building required packages
for your given srpm package and try to install all of these
packages in the system. If a new version of an already installed
package is available, it will be selected for installation.

For more information about its usage, please run:
$smart builddep -h.

Signed-off-by: fupan li <fupan.li@windriver.com>
---
 smart/backends/rpm/metadata.py | 30 +++++++++++++++++++++++++-----
 1 file changed, 25 insertions(+), 5 deletions(-)

diff --git a/smart/backends/rpm/metadata.py b/smart/backends/rpm/metadata.py
index f84a4d5..4569013 100644
--- a/smart/backends/rpm/metadata.py
+++ b/smart/backends/rpm/metadata.py
@@ -36,6 +36,7 @@ from smart import *
 import posixpath
 import locale
 import os
+import re
 
 NS_COMMON    = "http://linux.duke.edu/metadata/common"
 NS_RPM       = "http://linux.duke.edu/metadata/rpm"
@@ -164,6 +165,7 @@ class RPMMetaDataLoader(Loader):
         arch = None
         disttag = None
         distepoch = None
+        source = True
         info = {}
         reqdict = {}
         recdict = {}
@@ -198,7 +200,8 @@ class RPMMetaDataLoader(Loader):
                         skip = None
 
                 elif tag == ARCH:
-                    if getArchScore(elem.text) == 0:
+                    if getArchScore(elem.text) == 0 \
+                            and elem.text != "src" and elem.text != "nosrc":
                         skip = PACKAGE
                     else:
                         arch = elem.text
@@ -253,6 +256,7 @@ class RPMMetaDataLoader(Loader):
                 elif tag == SOURCERPM:
                     if elem.text:
                         info["sourcerpm"] = elem.text
+                        source = False
 
                 elif tag == GROUP:
                     if elem.text:
@@ -296,6 +300,9 @@ class RPMMetaDataLoader(Loader):
                         elif elem.get("hint") == "1" or elem.get("missingok") == "1":
                             recdict[(RPMRequires,
                                      ename, erelation, eversion)] = True
+			elif source:
+			    reqdict[(RPMBuildRequires,
+			             ename, erelation, eversion)] = True
                         else:
                             reqdict[(RPMRequires,
                                      ename, erelation, eversion)] = True
@@ -321,13 +328,18 @@ class RPMMetaDataLoader(Loader):
                         cnfdict[tup] = True
 
                     elif lasttag == CONFLICTS:
-                        cnfdict[(RPMConflicts,
+                        if source:
+                            cnfdict[(RPMBuildConflicts,
+                                 ename, erelation, eversion)] = True
+                        else:
+                            cnfdict[(RPMConflicts,
                                  ename, erelation, eversion)] = True
                                     
                 elif elem.tag == PACKAGE:
 
                     # Use all the information acquired to build the package.
-
+                    if source and arch != "src" and arch != "nosrc":
+                        arch = "src"
                     versionarch = "%s@%s" % (version, arch)
 
                     upgdict[(RPMObsoletes,
@@ -354,9 +366,16 @@ class RPMMetaDataLoader(Loader):
                             distversion += distepoch
                         versionarch = "%s@%s" % (distversion, arch)
 
-                    pkg = self.buildPackage((RPMPackage, name, versionarch),
+                    if "sourcerpm" in info and arch != "src" and arch != "nosrc":
+                        pkg = self.buildPackage((RPMPackage, name, versionarch),
                                             prvargs, reqargs, upgargs, cnfargs, recargs)
-                    pkg.loaders[self] = info
+                        pkg.loaders[self] = info
+                    else:
+                        epochre = re.compile("[0-9]+:")
+                        versionarch = epochre.sub("", versionarch)
+                        pkg = self.buildSourcePackage((RPMSourcePackage, name, versionarch),
+                                reqargs, cnfargs)
+                        pkg.loaders[self] = info
 
                     # Store the provided files for future usage.
                     if filedict:
@@ -376,6 +395,7 @@ class RPMMetaDataLoader(Loader):
                     arch = None
                     disttag = None
                     distepoch = None
+                    source = True
                     pkgid = None
                     reqdict.clear()
                     recdict.clear()
-- 
2.7.4

